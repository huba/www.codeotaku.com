#!/usr/bin/env ruby

require 'pathname'

require 'rexec'
require 'rexec/daemon'

require 'webrick'
require 'webrick/https'
require 'xmlrpc/server'

# Very simple XMLRPC daemon
class TestDaemon < RExec::Daemon::Base
	@@var_directory = "/tmp/ruby-test/var"
  
	def self.run
		puts "Starting server..."
    
		@@rpc_server = WEBrick::HTTPServer.new(
			:Port => 31337,
			:BindAddress => "0.0.0.0"
		)

		@@listener = XMLRPC::WEBrickServlet.new

		@@listener.add_handler("add") do |amount|
			@@count ||= 0
			@@count += amount
		end

		@@listener.add_handler("total") do
			@@count
		end

		@@rpc_server.mount("/RPC2", @@listener)

		$stdout.flush
		$stderr.flush

		@@rpc_server.start
	end

	def self.shutdown
		puts "Shutting down server..."
		@@rpc_server.shutdown
	end
end

TestDaemon.daemonize
